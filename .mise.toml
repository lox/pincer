[tools]
go = "1.23.6"

[tasks.test]
description = "Run Go tests"
run = "go test ./..."

[tasks.run]
description = "Run the backend server"
run = "go run ./cmd/pincer"

[tasks.dev]
description = "Run the backend in dev mode with a fixed HMAC key"
run = "PINCER_HTTP_ADDR=\"${PINCER_HTTP_ADDR:-:8080}\" PINCER_DB_PATH=\"${PINCER_DB_PATH:-./pincer.db}\" PINCER_TOKEN_HMAC_KEY=\"pincer-dev-token-hmac-key-change-me\" go run ./cmd/pincer"

[tasks.reset-db]
description = "Reset local dev database"
run = "DB_PATH=\"${PINCER_DB_PATH:-./pincer.db}\"; rm -f \"${DB_PATH}\" \"${DB_PATH}-shm\" \"${DB_PATH}-wal\""

[tasks.fmt]
description = "Format Go files"
run = "gofmt -w ./cmd ./internal"

[tasks.tidy]
description = "Sync Go module dependencies"
run = "go mod tidy"

[tasks.ios-generate]
description = "Generate iOS Xcode project from spec"
run = "cd ios/Pincer && xcodegen generate"

[tasks.ios-build]
description = "Build iOS app for Simulator (no signing)"
run = "xcodebuild -project ios/Pincer/Pincer.xcodeproj -scheme Pincer -destination 'generic/platform=iOS Simulator' build CODE_SIGNING_ALLOWED=NO"

[tasks.ios-run]
description = "Build, install, and launch iOS app in Simulator"
run = "scripts/ios_run_simulator.sh"

[tasks.ios-reset-token]
description = "Clear the simulator stored bearer token"
run = "DEVICE=\"${PINCER_IOS_DEVICE:-booted}\"; BUNDLE_ID=\"${PINCER_IOS_BUNDLE_ID:-com.lox.pincer}\"; xcrun simctl spawn \"${DEVICE}\" defaults delete \"${BUNDLE_ID}\" PINCER_BEARER_TOKEN"

[tasks.e2e-api]
description = "Run MVP API end-to-end checks against running backend"
run = "scripts/e2e_api.sh"

[tasks.e2e-ios]
description = "Run MVP iOS + backend end-to-end checks in simulator"
run = "scripts/e2e_ios.sh"
