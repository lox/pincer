[tools]
go = "1.25.5"
buf = "1.57.0"

[env]
PINCER_HTTP_ADDR = ':8080'
PINCER_DB_PATH = './pincer.db'
PINCER_TOKEN_HMAC_KEY = 'pincer-dev-token-hmac-key-change-me'
PINCER_IOS_BUNDLE_ID = 'com.lox.pincer'
PINCER_BASE_URL = '{{env.PINCER_BASE_URL | default(value="http://127.0.0.1:8080")}}'

[tasks.test]
description = "Run Go tests"
run = "go test ./..."

[tasks.run]
description = "Run the backend server"
run = "go run ./cmd/pincer serve"

[tasks.dev]
description = "Run the backend in dev mode with a fixed HMAC key"
run = "go run ./cmd/pincer serve"

[tasks.reset-db]
description = "Reset local dev database"
run = "rm -f \"${PINCER_DB_PATH}\" \"${PINCER_DB_PATH}-shm\" \"${PINCER_DB_PATH}-wal\""

[tasks.fmt]
description = "Format Go files"
run = "gofmt -w ./cmd ./internal"

[tasks.tidy]
description = "Sync Go module dependencies"
run = "go mod tidy"

[tasks.ios-generate]
description = "Generate iOS Xcode project from spec"
run = "cd ios/Pincer && xcodegen generate"

[tasks.ios-build]
description = "Build iOS app for Simulator (no signing)"
run = "xcodebuild -project ios/Pincer/Pincer.xcodeproj -scheme Pincer -destination 'generic/platform=iOS Simulator' build CODE_SIGNING_ALLOWED=NO"

[tasks.ios-run-simulator]
description = "Build, install, and launch iOS app in Simulator"
run = "scripts/ios_run_simulator.sh"

[tasks.ios-run-simulator.env]
PINCER_IOS_DEVICE = "iPhone 17 Pro"

[tasks.ios-run-device]
description = "Build, install, and launch iOS app on a connected physical device"
run = "scripts/ios_run_device.sh"

[tasks.ios-simulator-reset-token]
run = "xcrun simctl spawn booted defaults delete \"${PINCER_IOS_BUNDLE_ID}\" PINCER_BEARER_TOKEN"

[tasks.eval]
description = "Run eval tests (requires OPENROUTER_API_KEY)"
run = "go test ./internal/server -tags=eval -run TestEval -count=1 -timeout 120s -v"
[tasks.eval.env]
_.file = ".env"

[tasks.e2e-api]
description = "Alias for eval â€” run API end-to-end checks (requires OPENROUTER_API_KEY)"
run = "go test ./internal/server -tags=eval -run TestEval -count=1 -timeout 120s -v"

[tasks.e2e-xcuitest]
description = "Run XCUITest E2E against a fresh backend"
run = "scripts/e2e_xcuitest.sh"
