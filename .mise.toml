[tools]
go = "1.23.6"
buf = "1.57.0"

[env]
PINCER_HTTP_ADDR = ':8080'
PINCER_DB_PATH = './pincer.db'
PINCER_TOKEN_HMAC_KEY = 'pincer-dev-token-hmac-key-change-me'
PINCER_IOS_BUNDLE_ID = 'com.lox.pincer'
PINCER_BASE_URL = 'http://127.0.0.1:8080'

[tasks.test]
description = "Run Go tests"
run = "go test ./..."

[tasks.run]
description = "Run the backend server"
run = "go run ./cmd/pincer"

[tasks.dev]
description = "Run the backend in dev mode with a fixed HMAC key"
run = "go run ./cmd/pincer"

[tasks.reset-db]
description = "Reset local dev database"
run = "rm -f \"${PINCER_DB_PATH}\" \"${PINCER_DB_PATH}-shm\" \"${PINCER_DB_PATH}-wal\""

[tasks.fmt]
description = "Format Go files"
run = "gofmt -w ./cmd ./internal"

[tasks.tidy]
description = "Sync Go module dependencies"
run = "go mod tidy"

[tasks.ios-generate]
description = "Generate iOS Xcode project from spec"
run = "cd ios/Pincer && xcodegen generate"

[tasks.ios-build]
description = "Build iOS app for Simulator (no signing)"
run = "xcodebuild -project ios/Pincer/Pincer.xcodeproj -scheme Pincer -destination 'generic/platform=iOS Simulator' build CODE_SIGNING_ALLOWED=NO"

[tasks.ios-run]
description = "Build, install, and launch iOS app in Simulator"
run = "scripts/ios_run_simulator.sh"

[tasks.ios-run.env]
PINCER_IOS_DEVICE = "iPhone 17 Pro"

[tasks.ios-run-device]
description = "Build, install, and launch iOS app on a connected physical device"
run = "scripts/ios_run_device.sh"

[tasks.ios-run-device.env]
PINCER_IOS_SCHEME = "Pincer"
PINCER_IOS_BUNDLE_ID = "com.lox.pincer"

[tasks.ios-reset-token]
[tasks.ios-reset-token.env]
PINCER_IOS_DEVICE = "booted"
PINCER_IOS_BUNDLE_ID = "com.lox.pincer"
run = "xcrun simctl spawn \"${PINCER_IOS_DEVICE}\" defaults delete \"${PINCER_IOS_BUNDLE_ID}\" PINCER_BEARER_TOKEN"

[tasks.e2e-api]
description = "Run MVP API end-to-end checks against running backend"
[tasks.e2e-api.env]
PINCER_BASE_URL = "http://127.0.0.1:18080"
PINCER_HTTP_ADDR = ":18080"
PINCER_DB_PATH = "/tmp/pincer-e2e.db"
run = "scripts/e2e_api.sh"

[tasks.e2e-ios]
description = "Run MVP iOS + backend end-to-end checks in simulator"
[tasks.e2e-ios.env]
PINCER_BASE_URL = "http://127.0.0.1:18080"
PINCER_HTTP_ADDR = ":18080"
PINCER_DB_PATH = "/tmp/pincer-e2e.db"
run = "scripts/e2e_ios.sh"
